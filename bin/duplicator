#!/usr/bin/env node
// vim: set ft=javascript:

var duplicator = require('../')
var opts = require('optimist')
    .usage('Usage: $0 [-hv] -p port -f host:port [-d host:port] [-r int]')
    .options('h',
      { alias: 'help'
      , describe: 'show usage information'
      })
    .options('v',
      { alias: 'version'
      , describe: 'show version information'
      })
    .options('p',
      { alias: 'port'
      , describe: 'port to listen on, defaults to PORT'
      , 'default': process.env['PORT']
      })
    .options('f',
      { alias: 'forward'
      , describe: 'host to forward to'
      })
    .options('d',
      { alias: 'duplicate'
      , describe: 'host to duplicate to'
      })
    .options('r',
      { alias: 'rate'
      , describe: 'rate to sample traffic'
      , 'default': 1
      })
    .check(function(argv){
      if (argv.h) throw ''

      if (argv.v) {
        console.log(duplicator.version)
        process.exit()
      }

      if (!argv.p) throw 'You must specify a port, either via the -p option or' +
        'in the PORT environment variable'

      if (!argv.f) throw 'You must specify a host to forward to with -f option'
    })
  , argv = opts.argv

function serverInfo() {
  console.log("Listening on port:", argv.p)
  if (argv.f) console.log("Forwarding to:", argv.f)
  if (argv.d) console.log("Duplicating to:", argv.d)
  if (argv.r) console.log("Sample rate:", argv.r)
}

var server = duplicator(function(client, forward, duplicate) {
  if (argv.f) forward(argv.f)
  if (argv.d) duplicate(argv.d, argv.r)
}).listen(argv.p, serverInfo)
